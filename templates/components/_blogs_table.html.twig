<div class="table-responsive border border-black border-opacity-25 ">
    {# {{ dump(blogs) }} #}
    {% if blogs|length > 0 %}
        <table class="table table-striped table-hover">
            <thead class="table-light sticky-top">
            <tr>
                <th scope="col" class="p-3">Author</th>
                <th scope="col" class="p-3"><i class="bi bi-heart-fill fs-8 me-2"></i>Likes
                </th>
                <th scope="col" class="p-3">Title</th>
                <th scope="col" class="p-3">Content</th>
                <th scope="col" class="p-3">Categories</th>
                <th scope="col" class="p-3">
                    <a
                        href="{{ path('dashboard.allBlogs', { order: order == 'ASC' ? 'DESC' : 'ASC' }) }}">
                        Created
                        {% if order == 'ASC' %}
                            <i class="bi bi-sort-up-alt fs-6"></i>
                        {% else %}
                            <i class="bi bi-sort-down-alt fs-6"></i>
                        {% endif %}
                    </a>
                </th>
                <th scope="col" class="p-3">Status</th>
                <th scope="col" class="p-3">Update</th>
            </tr>
            </thead>
            <tbody>

            {% for key,blog in blogs %}
                {% set isOwner   = blog.author and blog.author.id == app.user.id %}
                {% set isAdmin   = 'ROLE_ADMIN' in app.user.roles %}
                {% set isBlogger = 'ROLE_BLOGGER' in app.user.roles %}
                {% set authorIsAdmin = blog.author and ('ROLE_ADMIN' in blog.author.roles) %}


                <tr>
                    {#   Author   #}
                    <td class="p-3 fs-7">
                        {% if blog.author %}
                            <a href="{{ path('dashboard.allBlogs', { id: blog.author.id }) }}"
                               class="link-no-underline-black d-inline-block align-items-center"
                               data-tooltip="Users"
                               data-tooltip-placement="right">
                                {{ blog.author.username|u.truncate(15, '...') }}

                                {% if isOwner %}
                                    <span class="new_category_indicator"
                                          data-bs-toggle="tooltip"
                                          data-bs-placement="top"
                                          data-bs-title="You"></span>
                                {% endif %}
                            </a>
                        {% else %}
                            <span class="text-secondary">Unknown</span>
                        {% endif %}
                    </td>

                    {#   Number of Likes   #}
                    <td class="p-3 fs-7">
                        <div class="d-flex align-items-center gap-1">
                            <span>{{ likesCount[blog.id] ?? 0 }}</span>
                        </div>
                    </td>

                    {#   Title   #}
                    <td class="p-3 fs-7">
                        <a href="{{ path('blog.one_blog', { id: blog.id }) }}"
                           class="link-no-underline-black d-inline-block align-items-center"
                           data-tooltip="Users"
                           data-tooltip-placement="right">
                            <i class="bi bi-link"></i>
                            {{ blog.title|u.truncate(15, '...') }}
                        </a>
                    </td>

                    {#   Content   #}
                    <td class="p-3 fs-7">{{ blog.excerpt|striptags|u.truncate(15, '...') }}</td>

                    {#   Categories   #}
                    <td class="p-3 fs-7">
                        {% if blog.categories|length > 0 %}
                            {{ blog.categories|map(c => c.name)|join(', ') }}
                        {% else %}
                            <span class="text-secondary">No categories</span>
                        {% endif %}
                    </td>

                    {#   Created_at   #}
                    <td class="p-3 fs-7">{{ blog.createdAt|date('Y-m-d') }}</td>

                    {#   Status  #}
                    <td class="p-3 fs-7">
                        <div class="d-flex align-items-center gap-1">
                                <span>
                                    <a
                                        href="#"
                                        class="open-status-blog-modal"
                                        data-blog-id="{{ blog.id }}"
                                        data-blog-name="{{ blog.title }}"
                                    >
                                        {% if (blog.published) %}
                                            <span class="indicator published"
                                                  data-bs-toggle="tooltip"
                                                  data-bs-placement="top"
                                                  data-bs-title="Published"
                                            >
                                            </span>
                                        {% else %}
                                            <span class="indicator danger"
                                                  data-bs-toggle="tooltip"
                                                  data-bs-placement="top"
                                                  data-bs-title="Unpublished"
                                            >
                                            </span>
                                        {% endif %}
                                    </a>
                                </span>
                        </div>
                    </td>

                    {#   Action buttons   #}
                    <td class="p-3">
                        {# DELETE BUTTON: visible to any logged-in user (ROLE_USER, ROLE_BLOGGER, ROLE_ADMIN) #}
                        {% if
                            (isAdmin and not authorIsAdmin) or (isOwner) %}
                            {# admin can delete bloggerâ€™s blog || owner can delete own blog #}
                            <a class="me-3 open-delete-blog-modal delete-btn"
                               href="#"
                               data-blog-id="{{ blog.id }}"
                               data-blog-name="{{ blog.title }}">
                                <i data-bs-toggle="tooltip"
                                   data-bs-placement="top"
                                   data-bs-title="Delete"
                                   class="bi bi-x-circle fs-5">
                                </i>
                            </a>
                        {% endif %}


                        {# EDIT RULE:
                           - Normal users/bloggers: can edit
                           - Admin: can ONLY edit if they are the author
                        #}
                        {% if isOwner %}
                            {# edit #}
                            <a
                                class="edit-btn"
                                href="{{ path('dashboard.editBlog', {id: blog.id} ) }}"
                                data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                data-bs-title="Edit">
                                <i class="bi bi-pencil-square fs-5"></i>
                            </a>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% else %}
        {{ include('components/_emptyPage.html.twig' , {message : "No Blogs yet", linkText: "New Blog", linkPath: app.user.verified ? 'dashboard.createBlog' : null }) }}
    {% endif %}


    {% include "components/_modalConfirm.html.twig" with {
        modal_id: "globalDeleteBlogModal",
        title: "Confirm Deletion",
        body: "Are you sure you want to delete the blog '<strong id=\"deleteBlog\"></strong>'?",
        confirm_path: "",
        confirm_text: "Delete"
    } %}

    {% include "components/_modalConfirm.html.twig" with {
        modal_id: "globalStatusBlogModal",
        title: "Update Status",
        body: "Are you sure you want to update the blog '<strong id=\"statusBlog\"></strong>' status?",
        confirm_path: "",
        confirm_text: "Confirm"
    } %}
</div>


<script>
    document.addEventListener('click', function (e) {

        const delBtn = e.target.closest('.open-delete-blog-modal');
        if (delBtn) {
            e.preventDefault();
            const blogId = delBtn.dataset.blogId;
            const blogName = delBtn.dataset.blogName;
            const modalEl = document.getElementById('globalDeleteBlogModal');
            const form = modalEl.querySelector('#confirmActionForm');
            const blogNameEl = modalEl.querySelector('#deleteBlog');

            if (form) {
                form.action = `/blog/delete/${blogId}`;
            }
            if (blogNameEl) {
                blogNameEl.textContent = blogName;
            }

            // Show the modal using Bootstrap
            if (window.bootstrap && window.bootstrap.Modal) {
                const modal = window.bootstrap.Modal.getOrCreateInstance(modalEl);
                modal.show();
            }
        }

        const statusBtn = e.target.closest('.open-status-blog-modal');
        if (statusBtn) {
            e.preventDefault();
            const blogId = statusBtn.dataset.blogId;
            const blogName = statusBtn.dataset.blogName;
            const modalEl = document.getElementById('globalStatusBlogModal');
            const form = modalEl.querySelector('#confirmActionForm');
            const blogNameEl = modalEl.querySelector('#statusBlog');

            if (form) {
                form.action = `/blog/blog-status/${blogId}`;
            }
            if (blogNameEl) {
                blogNameEl.textContent = blogName;
            }

            // Show the modal using Bootstrap
            if (window.bootstrap && window.bootstrap.Modal) {
                const modal = window.bootstrap.Modal.getOrCreateInstance(modalEl);
                modal.show();
            }
        }
    });

</script>
